/**
 * Sailor.js
 *
 * The #1 way to win the internet with Sails
 *
 * Copyright (c) 2014 mrfishie - Licensed under the MIT license
 */

var sailor=window.sailor||{};(function(){function e(e,t){return new Promise(function(n,r){t=t||{};io.socket.get(e,t,n)})}function t(e){var t=e.split("/");if(t.length>1){e=t.splice(t.length-1,1).join();t=t.join("/")+"/"}else t="";return"/"+t+e}function r(e,t,r,i){i=i||{};var o=e+JSON.stringify(i);if(_.has(n,o)){var u=n[o];if(t){u.itemDef=t;u.refresh()}if(r)u.modelDef=r;return u.value}var a=new s(e,t,r,i);n[o]=a;return a.value}function i(e,t){var n=e;_.merge(t,sailor.calculate(function(e){if(!this._previous)return;var t=_.isArray(this._previous),r;if(t){r=_.map(this._previous,function(e){if(_.isNumber(e))return e;return e.id})}else r=[_.isNumber(this._previous)?this._previous:this._previous.id];return n.value.asyncSearch({id:r}).then(function(n){if(!e.noRefresh)for(var r=0;r<n.length;r++)n[r].refresh();if(t)return n;return n.length?n[0]:null})},{__connection:e.name}));return t}function s(e,s,o,a){function c(e){if(_.has(l,e.verb)){if(l[e.verb](e)){f.emit("changed",e.verb,e)}}}this.name=e;this.url=t(e);this.itemDef=s||{};this.modelDef=o||{};this.filter=a||{};this.children={"{}":this};this.eventHandlers={};this.value=[];this.value._isModel=true;var f=this;_.merge(this.value,this.modelDef);this.value.bind=function(e,t,n){if(!_.isString(t)){n=t;t=f.name+"s"}n=n||{};var r=f,i=_.merge(_.cloneDeep(f.filter),n);if(!_.isEqual(i,f.filter))r=this.find(n);e[t]=r.value;return r.value};this.value.find=function(e){var t=_.merge(_.cloneDeep(f.filter),_.mapValues(e,function(e){if(_.has(e,"_model"))return e.serverProperties();return e}));var i=JSON.stringify(t);if(_.has(f.children,i))return f.children[i].value;var s=r(f.name,f.itemDef,f.modelDef,t);f.children[i]=s;n[f.name+i].children=f.children;return s.value};this.value.findOne=function(e){var t=this;return new Promise(function(n){t.find(e).on("ready",function(e){if(e.length)n(e[0]);else n(null)})})};this.value.search=function(e){var t=_.merge(_.cloneDeep(f.filter),e);if(_.isEqual(t,f.filter))return this;var n=[];for(var r=0;r<this.length;r++){var i=this[r],s=false;_.forEach(t,function(e,t){var n=_.isArray(e)?e:[e];for(var r=0;r<n.length;r++){if(i[t]===n[r]){s=true;return false}}});if(s)n.push(i)}return n};this.value.asyncSearch=function(e){var t=this;return new Promise(function(n,r){t.on("ready",function(){n(t.search(e))})})};this.value.on=function(e,t){if(!_.has(f.eventHandlers,e))f.eventHandlers[e]=[];var n=f.eventHandlers[e];n.push(t);if(n.triggered)t.apply(window,n.argumentMemory)};this.value.off=function(e,t){if(!_.has(f.eventHandlers,e))return;var n=f.eventHandlers[e],r=n.indexOf(t);if(r!==-1)n.splice(r,1)};this.value.refresh=function(){var e=[];for(var t=0;t<this.length;t++)e.push(this[t].refresh());return Promise.all(e)};this.emit=function(e,t){if(!_.has(this.eventHandlers,e))return;var n=this.eventHandlers[e];t=_.toArray(arguments).slice(1);for(var r=0;r<n.length;r++){n[r].apply(window,t)}};this.emitMemory=function(e,t){if(!_.has(this.eventHandlers,e))this.eventHandlers[e]=[];var n=this.eventHandlers[e];this.emit.apply(this,arguments);t=_.toArray(arguments).slice(1);if(n.triggered)_.merge(n.argumentMemory,t);else{n.triggered=true;n.argumentMemory=t}};this.refresh();var l={created:function(e){function n(){f.value.push(t);f.emit("created",t)}var t=new u(e.data,f);if(_.isEqual(f.filter,{}))n();else{t.matches(f.filter).then(function(e){if(e)n()})}},updated:function(e){var t=f.value.search({id:e.id});if(t.length){t[0].update(e.data,false);f.emit("updated",t[0]);return true}return false},destroyed:function(e){var t=f.value.search({id:e.id});if(t.length){f.value.splice(f.value.indexOf(t[0]),1);f.emit("removed",t[0]);return true}return false}};io.socket.on(this.name,c);i(this,this.value)}function o(e){function t(t){u.call(this,t,e);e.value.push(this);this._create(t).catch(function(){})}t.prototype=_.create(u.prototype,{constructor:t});i(e,t);return t}function u(e,t){this._model=t;this._def=t.itemDef;this._update(e||{})}var n=sailor._modelCache={};sailor.model=function(e,t,i){var s=r(e,t,i);if(!_.has(sailor,e+"s")){s.bind(sailor);sailor[e]=o(n[e+"{}"])}return s};sailor.bind=function(e,t,r,i){var s=e+"{}";if(!_.has(n,s))throw new Error("The specified model does not exist: "+e);var o=n[s];return o.bind(t,r,i)};sailor.calculate=function(e,t){return _.merge({__precalc:e},t)};s.prototype.refresh=function(){e(this.url,this.filter).bind(this).then(function(e){var t=_.isArray(e)?e:[e];while(this.value.length>0)this.value.pop();for(var n=0;n<t.length;n++){this.value.push(new u(t[n],this))}this.emitMemory("ready",this.value)});return this};s.prototype.save=function(){for(var e=0;e<this.value.length;e++){this.value[e].save()}};u.prototype._update=function(e,t){_.forEach(e,function(e,t){if(_.isFunction(e)){var n=this;Promise.resolve(e).then(function(e){n[t]=e})}else this[t]=e},this);_.merge(this,e);_.forEach(this._def,function(n,r){if(_.has(n,"__precalc")){var i=n.__precalc,s=this,o=e[r];Promise.resolve(i.call(_.merge(s,{_previous:o}),t||{})).then(function(e){s[r]=_.merge(e,o)})}else this[r]=n},this);delete this._previous};u.prototype.update=function(e,t){this._update(e);if(typeof t==="undefined")t=true;var n=this;return new Promise(function(r,i){if(t){if(_.has(n,"id")){io.socket.post(n._model.url+"/update/"+n.id,n.serverProperties(e),r)}else r(n._create(e))}else r()})};u.prototype.save=function(){var e=this;return new Promise(function(t,n){if(_.has(e,"id")){io.socket.post(e._model.url+"/update/"+e.id,e.serverProperties(),t)}else t(e._create())})};u.prototype._create=function(e){var t=this;return new Promise(function(n,r){var i=t.serverProperties(e);io.socket.put(t._model.url+"/create/",i,function(e){if(e.error)r(e);else{_.merge(i,e);t._update(i)}})})};u.prototype.refresh=function(){if(!_.has(this,"id"))return this._create();return e(this._model.url+"/"+this.id).bind(this).then(function(e){this._update(e,{noRefresh:true})})};u.prototype.serverProperties=function(e){var t={};_.forEach(e||this,function(e,n){if(e instanceof u)t[n]=e.serverProperties();else if(_.isArray(e)){var r=[];for(var i=0;i<e.length;i++){if(!(e[i]instanceof u)){r=false;break}else r.push(e[i].serverProperties())}if(r)t[n]=r;else t[n]=e}else if(_.has(this._def,n)){if(_.has(this._def[n],"__connection")){t[n]=e}}else if(n!=="_model"&&n!=="_def")t[n]=e},this);return t};u.prototype.destroy=function(){var e=this._model.value.indexOf(this);if(e>=0)this._model.value.splice(e,1);var t=this;return new Promise(function(e,n){io.socket.delete(t._model.url+"/delete/?id="+this.id,{},e)})};u.prototype.matches=function(t){return e(this._model.url,t).bind(this).then(function(e){for(var t=0;t<e.length;t++){if(e[t].id===this.id)return true}return false})}})()