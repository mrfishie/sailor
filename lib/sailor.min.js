var sailor=window.sailor||{};!function(){function e(e,t){return new Promise(function(r){t=t||{},io.socket.get(e,t,r)})}function t(e){var t=e.split("/");return t.length>1?(e=t.splice(t.length-1,1).join(),t=t.join("/")+"/"):t="","/"+t+e}function r(e,t,r,i){i=i||{};var s=e+JSON.stringify(i);if(_.has(a,s)){var o=a[s];return t&&(o.itemDef=t,o.refresh()),r&&(o.modelDef=r),o.value}var u=new n(e,t,r,i);return a[s]=u,u.value}function i(e,t){var r=e;return _.merge(t,sailor.calculate(function(e){if(this._previous){var t,i=_.isArray(this._previous);return t=i?_.map(this._previous,function(e){return _.isNumber(e)?e:e.id}):[_.isNumber(this._previous)?this._previous:this._previous.id],r.value.asyncSearch({id:t}).then(function(t){if(!e.noRefresh)for(var r=0;r<t.length;r++)t[r].refresh();return i?t:t.length?t[0]:null})}},{__connection:e.name})),t}function n(e,n,s,u){function h(e){_.has(f,e.verb)&&f[e.verb](e)&&l.emit("updated",e.verb,e)}this.name=e,this.url=t(e),this.itemDef=n||{},this.modelDef=s||{},this.filter=u||{},this.children={"{}":this},this.eventHandlers={},this.value=[];var l=this;_.merge(this.value,this.modelDef),this.value.bind=function(e,t,r){_.isString(t)||(r=t,t=l.name+"s"),r=r||{};var i=l,n=_.merge(_.cloneDeep(l.filter),r);return _.isEqual(n,l.filter)||(i=this.find(r)),e[t]=i.value,i.value},this.value.find=function(e){var t=_.merge(_.cloneDeep(l.filter),e),i=JSON.stringify(t);if(_.has(l.children,i))return l.children[i];var n=r(l.name,l.itemDef,l.modelDef,t);return l.children[i]=n,a[l.name+i].children=l.children,n},this.value.findOne=function(e){var t=this;return new Promise(function(r){t.find(e).on("ready",function(e){r(e.length?e[0]:null)})})},this.value.search=function(e){var t=_.merge(_.cloneDeep(l.filter),e);if(_.isEqual(t,l.filter))return this;for(var r=[],i=0;i<this.length;i++){var n=this[i],s=!1;_.forEach(t,function(e,t){for(var r=_.isArray(e)?e:[e],i=0;i<r.length;i++)if(n[t]===r[i])return s=!0,!1}),s&&r.push(n)}return r},this.value.asyncSearch=function(e){var t=this;return new Promise(function(r){t.on("ready",function(){r(t.search(e))})})},this.value.on=function(e,t){_.has(l.eventHandlers,e)||(l.eventHandlers[e]=[]);var r=l.eventHandlers[e];r.push(t),r.triggered&&t.apply(window,r.argumentMemory)},this.value.off=function(e,t){if(_.has(l.eventHandlers,e)){var r=l.eventHandlers[e],i=r.indexOf(t);-1!==i&&r.splice(i,1)}},this.value.refresh=function(){for(var e=[],t=0;t<this.length;t++)e.push(this[t].refresh());return Promise.all(e)},this.emit=function(e,t){if(_.has(this.eventHandlers,e)){var r=this.eventHandlers[e];t=_.toArray(arguments).slice(1);for(var i=0;i<r.length;i++)r[i].apply(window,t)}},this.emitMemory=function(e,t){_.has(this.eventHandlers,e)||(this.eventHandlers[e]=[]);var r=this.eventHandlers[e];this.emit.apply(this,arguments),t=_.toArray(arguments).slice(1),r.triggered?_.merge(r.argumentMemory,t):(r.triggered=!0,r.argumentMemory=t)},this.refresh();var f={created:function(e){function t(){l.value.push(r),l.emit("created",r)}var r=new o(e.data,l);_.isEqual(l.filter,{})?t():r.matches(l.filter).then(function(e){e&&t()})},updated:function(e){var t=l.value.search({id:e.id});return t.length?(t[0].update(e.data,!1),l.emit("updated",t[0]),!0):!1},destroyed:function(e){var t=l.value.search({id:e.id});return t.length?(l.value.splice(l.value.indexOf(t[0]),1),l.emit("removed",t[0]),!0):!1}};io.socket.on(this.name,h),i(this,this.value)}function s(e){function t(t){o.call(this,t,e),e.value.push(this),this._create(t).catch(function(){})}return t.prototype=_.create(o.prototype,{constructor:t}),i(e,t),t}function o(e,t){this._model=t,this._def=t.itemDef,this._update(e||{})}var a=sailor._modelCache={};sailor.model=function(e,t,i){var n=r(e,t,i);return _.has(sailor,e+"s")||(n.bind(sailor),sailor[e]=s(a[e+"{}"])),n},sailor.bind=function(e,t,r,i){var n=e+"{}";if(!_.has(a,n))throw new Error("The specified model does not exist: "+e);var s=a[n];return s.bind(t,r,i)},sailor.calculate=function(e,t){return _.merge({__precalc:e},t)},n.prototype.refresh=function(){return e(this.url,this.filter).bind(this).then(function(e){for(var t=_.isArray(e)?e:[e];this.value.length>0;)this.value.pop();for(var r=0;r<t.length;r++)this.value.push(new o(t[r],this));this.emitMemory("ready",this.value)}),this},n.prototype.save=function(){for(var e=0;e<this.value.length;e++)this.value[e].save()},o.prototype._update=function(e,t){_.forEach(e,function(e,t){if(_.isFunction(e)){var r=this;Promise.resolve(e).then(function(e){r[t]=e})}else this[t]=e},this),_.merge(this,e),_.forEach(this._def,function(r,i){if(_.has(r,"__precalc")){var n=r.__precalc,s=this,o=e[i];Promise.resolve(n.call(_.merge(s,{_previous:o}),t||{})).then(function(e){s[i]=_.merge(e,o)})}else this[i]=r},this),delete this._previous},o.prototype.update=function(e,t){this._update(e),"undefined"==typeof t&&(t=!0);var r=this;return new Promise(function(i){t?_.has(r,"id")?io.socket.post(r._model.url+"/update/"+r.id,r.serverProperties(e),i):i(r._create(e)):i()})},o.prototype.save=function(){var e=this;return new Promise(function(t){_.has(e,"id")?io.socket.post(e._model.url+"/update/"+e.id,e.serverProperties(),t):t(e._create())})},o.prototype._create=function(e){var t=this;return new Promise(function(r,i){var n=t.serverProperties(e);io.socket.put(t._model.url+"/create/",n,function(e){e.error?i(e):(_.merge(n,e),t._update(n))})})},o.prototype.refresh=function(){return _.has(this,"id")?e(this._model.url+"/"+this.id).bind(this).then(function(e){this._update(e,{noRefresh:!0})}):this._create()},o.prototype.serverProperties=function(e){var t={};return _.forEach(e||this,function(e,r){if(e instanceof o)t[r]=e.serverProperties();else if(_.isArray(e)){for(var i=[],n=0;n<e.length;n++){if(!(e[n]instanceof o)){i=!1;break}i.push(e[n].serverProperties())}t[r]=i?i:e}else _.has(this._def,r)?_.has(this._def[r],"__connection")&&(t[r]=e):"_model"!==r&&"_def"!==r&&(t[r]=e)},this),t},o.prototype.destroy=function(){var e=this._model.value.indexOf(this);e>=0&&this._model.value.splice(e,1);var t=this;return new Promise(function(e){io.socket.delete(t._model.url+"/delete/?id="+this.id,{},e)})},o.prototype.matches=function(t){return e(this._model.url,t).bind(this).then(function(e){for(var t=0;t<e.length;t++)if(e[t].id===this.id)return!0;return!1})}}();